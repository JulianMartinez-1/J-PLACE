<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Publicar producto â€” J-PLACE</title>
  <link rel="icon" href="images/J-PLACE.png"type="image/png"> 
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="header">
    <nav class="navbar">
      <a href="index.html" class="logo"><span class="logo-text">J-PLACE</span></a>
      <ul class="nav-links">
        <li><a href="index.html" data-i18n="nav.inicio">Inicio</a></li>
      </ul>
      <div id="user-area" style="display:flex;align-items:center;gap:0.6rem">
        <!-- user-area rellenado por main.js -->
      </div>
    </nav>
  </header>

  <main class="publish-page">
    <div class="publish-container">
      <div class="publish-header">
        <div class="publish-icon">ğŸ“¦</div>
        <h1>Publicar producto</h1>
        <p class="publish-subtitle">Completa la informaciÃ³n de tu producto para ponerlo a la venta</p>
      </div>

      <div class="publish-content">
        <form id="product-form" enctype="multipart/form-data" class="publish-form">
          
          <!-- SecciÃ³n de ImÃ¡genes -->
          <div class="form-section">
            <div class="section-title">
              <span class="section-icon">ğŸ“¸</span>
              <h2>Fotos del producto</h2>
            </div>
            <div class="image-upload-area">
              <input id="images" name="images" type="file" accept="image/*" multiple required style="display:none;" />
              <label for="images" class="upload-box">
                <div class="upload-icon">ğŸ“·</div>
                <div class="upload-text">
                  <strong>Haz clic para subir fotos</strong>
                  <span>o arrastra y suelta aquÃ­</span>
                </div>
                <div class="upload-hint">MÃ­nimo 1 foto, mÃ¡ximo 10 â€¢ JPG, PNG, WEBP</div>
              </label>
              <div id="image-preview" class="image-preview-grid"></div>
            </div>
          </div>

          <!-- SecciÃ³n de InformaciÃ³n -->
          <div class="form-section">
            <div class="section-title">
              <span class="section-icon">â„¹ï¸</span>
              <h2>InformaciÃ³n bÃ¡sica</h2>
            </div>
            
            <div class="form-row">
              <label for="nombre">
                <span class="label-icon">ğŸ·ï¸</span>
                Nombre del producto
              </label>
              <input id="nombre" name="nombre" type="text" required placeholder="Ej: iPhone 15 Pro Max 256GB" />
              <small class="field-hint">SÃ© descriptivo y especÃ­fico</small>
            </div>

            <div class="form-row">
              <label for="category">
                <span class="label-icon">ğŸ“‚</span>
                CategorÃ­a
              </label>
              <select id="category" name="category" required>
                <option value="" disabled selected>Selecciona una categorÃ­a</option>
                <option value="tecnologia">ğŸ“± TecnologÃ­a</option>
                <option value="moda">ğŸ‘” Moda</option>
                <option value="hogar">ğŸ  Hogar</option>
                <option value="deportes">âš½ Deportes</option>
                <option value="electronica">ğŸ’» ElectrÃ³nica</option>
                <option value="juguetes">ğŸ§¸ Juguetes</option>
                <option value="herramientas">ğŸ”§ Herramientas</option>
                <option value="libros">ğŸ“š Libros</option>
                <option value="electrodomesticos">ğŸ”Œ ElectrodomÃ©sticos</option>
                <option value="belleza">ğŸ’„ Belleza</option>
                <option value="musica">ğŸµ MÃºsica</option>
                <option value="mascotas">ğŸ¾ Mascotas</option>
                <option value="jardin">ğŸŒ± JardÃ­n</option>
                <option value="alimentos">ğŸ” Alimentos</option>
                <option value="automoviles">ğŸš— AutomÃ³viles</option>
                <option value="arte">ğŸ¨ Arte</option>
                <option value="fotografia">ğŸ“· FotografÃ­a</option>
                <option value="oficina">ğŸ“ Oficina</option>
              </select>
            </div>

            <div class="form-row">
              <label for="precio">
                <span class="label-icon">ğŸ’°</span>
                Precio
              </label>
              <div class="price-input-wrapper">
                <span class="currency-symbol">$</span>
                <input id="precio" name="precio" type="number" step="0.01" min="0" required placeholder="0.00" />
                <span class="currency-code">USD</span>
              </div>
              <small class="field-hint">Establece un precio justo y competitivo</small>
            </div>
          </div>

          <!-- SecciÃ³n de DescripciÃ³n -->
          <div class="form-section">
            <div class="section-title">
              <span class="section-icon">ğŸ“</span>
              <h2>DescripciÃ³n detallada</h2>
            </div>
            
            <div class="form-row">
              <label for="descripcion">
                Describe tu producto
              </label>
              <textarea id="descripcion" name="descripcion" rows="6" required placeholder="Incluye detalles importantes: estado, caracterÃ­sticas, dimensiones, incluye caja, garantÃ­a, etc."></textarea>
              <div class="char-counter">
                <span id="char-count">0</span> / 500 caracteres
              </div>
            </div>
          </div>

          <!-- InformaciÃ³n de aprobaciÃ³n -->
          <div class="approval-notice">
            <div class="notice-icon">â³</div>
            <div class="notice-content">
              <strong>AprobaciÃ³n requerida</strong>
              <p>Tu producto serÃ¡ revisado por un administrador antes de publicarse. RecibirÃ¡s una notificaciÃ³n cuando sea aprobado.</p>
            </div>
          </div>

          <div class="form-actions publish-actions">
            <button type="button" class="btn-secondary" onclick="window.history.back()">
              â† Cancelar
            </button>
            <button type="submit" class="btn-primary publish-submit">
              <span class="btn-text">ğŸ“¤ Publicar producto</span>
              <span class="btn-loader hidden">â³</span>
            </button>
          </div>
        </form>

        <p id="prod-feedback" class="publish-feedback" aria-live="polite"></p>
      </div>
    </div>
  </main>

  <div id="footer-include"></div>
  <script src="main.js"></script>
  <script>
    (function(){
      const form = document.getElementById('product-form');
      const feedback = document.getElementById('prod-feedback');
      const imagesInput = document.getElementById('images');
      const previewGrid = document.getElementById('image-preview');
      const descripcionInput = document.getElementById('descripcion');
      const charCount = document.getElementById('char-count');
      const btnSubmit = form.querySelector('.publish-submit');
      const btnText = btnSubmit.querySelector('.btn-text');
      const btnLoader = btnSubmit.querySelector('.btn-loader');

      // Character counter
      descripcionInput.addEventListener('input', function(){
        const length = this.value.length;
        charCount.textContent = Math.min(length, 500);
        if(length > 500) {
          charCount.style.color = 'crimson';
        } else {
          charCount.style.color = 'inherit';
        }
      });

      // Drag and drop functionality
      const uploadBox = document.querySelector('.upload-box');
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        uploadBox.addEventListener(eventName, preventDefaults, false);
      });
      
      function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
      }
      
      ['dragenter', 'dragover'].forEach(eventName => {
        uploadBox.addEventListener(eventName, () => {
          uploadBox.classList.add('drag-active');
        }, false);
      });
      
      ['dragleave', 'drop'].forEach(eventName => {
        uploadBox.addEventListener(eventName, () => {
          uploadBox.classList.remove('drag-active');
        }, false);
      });
      
      uploadBox.addEventListener('drop', function(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        imagesInput.files = files;
        imagesInput.dispatchEvent(new Event('change'));
      }, false);

      // Image preview
      imagesInput.addEventListener('change', function(){
        previewGrid.innerHTML = '';
        const files = Array.from(this.files || []);
        
        if(files.length > 10) {
          feedback.className = 'publish-feedback error';
          feedback.textContent = 'MÃ¡ximo 10 imÃ¡genes permitidas';
          this.value = '';
          return;
        }

        files.forEach((file, index) => {
          const reader = new FileReader();
          reader.onload = function(e){
            const previewItem = document.createElement('div');
            previewItem.className = 'preview-item';
            previewItem.innerHTML = `
              <img src="${e.target.result}" alt="Preview ${index + 1}">
              <button type="button" class="remove-preview" data-index="${index}" title="Eliminar">âœ•</button>
              ${index === 0 ? '<span class="main-badge">Principal</span>' : ''}
            `;
            previewGrid.appendChild(previewItem);
          };
          reader.readAsDataURL(file);
        });
      });

      // Remove image from preview
      previewGrid.addEventListener('click', function(e){
        if(e.target.classList.contains('remove-preview')){
          const index = parseInt(e.target.dataset.index);
          const dt = new DataTransfer();
          const files = Array.from(imagesInput.files);
          files.forEach((file, i) => {
            if(i !== index) dt.items.add(file);
          });
          imagesInput.files = dt.files;
          imagesInput.dispatchEvent(new Event('change'));
        }
      });

      // Check session
      const rawUser = localStorage.getItem('jplace_user');
      const token = localStorage.getItem('jplace_token');
      if (!rawUser || !token) {
        feedback.className = 'publish-feedback error';
        feedback.textContent = 'ğŸ”’ Debes iniciar sesiÃ³n para publicar productos.';
        form.querySelectorAll('input, textarea, select, button').forEach(el=>el.disabled=true);
        return;
      }

      // Form submit
      form.addEventListener('submit', async function(e){
        e.preventDefault(); 
        feedback.textContent='';
        feedback.className = 'publish-feedback';
        
        const nombre = document.getElementById('nombre').value.trim();
        const precio = document.getElementById('precio').value;
        const descripcion = document.getElementById('descripcion').value.trim();
        const category = document.getElementById('category').value;
        const files = Array.from(imagesInput.files || []);
        
        console.log('ğŸ“‹ Datos del formulario:', {
          nombre: nombre,
          nombreLength: nombre.length,
          precio: precio,
          precioNumber: Number(precio),
          descripcion: descripcion.substring(0, 50) + '...',
          descripcionLength: descripcion.length,
          category: category,
          filesCount: files.length
        });

        // Validations
        if (!nombre || nombre.length < 3) { 
          feedback.className='publish-feedback error'; 
          feedback.textContent='âŒ El nombre debe tener al menos 3 caracteres.';
          feedback.style.display = 'flex';
          console.log('ValidaciÃ³n fallÃ³: nombre muy corto');
          return; 
        }
        if (!category) { 
          feedback.className='publish-feedback error'; 
          feedback.textContent='âŒ Selecciona una categorÃ­a.';
          feedback.style.display = 'flex';
          console.log('ValidaciÃ³n fallÃ³: sin categorÃ­a');
          return; 
        }
        if (!precio || Number(precio) <= 0) { 
          feedback.className='publish-feedback error'; 
          feedback.textContent='âŒ El precio debe ser mayor a cero.';
          feedback.style.display = 'flex';
          console.log('ValidaciÃ³n fallÃ³: precio invÃ¡lido');
          return; 
        }
        if (!descripcion || descripcion.length < 20) { 
          feedback.className='publish-feedback error'; 
          feedback.textContent='âŒ La descripciÃ³n debe tener al menos 20 caracteres.';
          feedback.style.display = 'flex';
          console.log('ValidaciÃ³n fallÃ³: descripciÃ³n muy corta', descripcion.length);
          return; 
        }
        if (!files.length) { 
          feedback.className='publish-feedback error'; 
          feedback.textContent='âŒ Se requiere al menos 1 foto del producto.';
          feedback.style.display = 'flex';
          console.log('ValidaciÃ³n fallÃ³: sin imÃ¡genes');
          return; 
        }
        
        console.log('âœ… Todas las validaciones pasaron, enviando al servidor...');

        // Show loader
        btnText.classList.add('hidden');
        btnLoader.classList.remove('hidden');
        btnSubmit.disabled = true;

        const fd = new FormData(); 
        fd.append('nombre', nombre); 
        fd.append('precio', precio); 
        fd.append('descripcion', descripcion);
        fd.append('category', category);
        files.forEach(f => fd.append('images', f, f.name));

        try {
          const res = await fetch('http://localhost:4000/api/productos', {
            method: 'POST', body: fd, headers: { 'Authorization': 'Bearer ' + token }
          });
          const data = await res.json().catch(()=>({}));
          
          console.log('Respuesta del servidor:', { status: res.status, data });
          
          btnText.classList.remove('hidden');
          btnLoader.classList.add('hidden');
          btnSubmit.disabled = false;

          if (res.status === 201) {
            feedback.className = 'publish-feedback success';
            feedback.textContent = 'âœ… ' + (data.mensaje || 'Producto enviado. Espera la confirmaciÃ³n del administrador.');
            form.querySelectorAll('input, textarea, select, button').forEach(el=>el.disabled=true);
            setTimeout(() => window.location.href = 'index.html', 3000);
            return;
          }
          
          // Mostrar errores de validaciÃ³n especÃ­ficos
          if (res.status === 400 && data.errors && Array.isArray(data.errors)) {
            const errorMessages = data.errors.map(err => `${err.field}: ${err.message}`).join(', ');
            feedback.className='publish-feedback error';
            feedback.textContent = 'âŒ ' + errorMessages;
            console.error('Errores de validaciÃ³n:', data.errors);
            return;
          }
          
          feedback.className='publish-feedback error';
          feedback.textContent = 'âŒ ' + (data.msg || data.error || 'Error subiendo el producto.');
          console.error('Error del servidor:', data);
        } catch(err) {
          btnText.classList.remove('hidden');
          btnLoader.classList.add('hidden');
          btnSubmit.disabled = false;
          feedback.className='publish-feedback error'; 
          feedback.textContent='âŒ No fue posible conectar con el servidor.'; 
          console.error('Error de conexiÃ³n:', err);
        }
      });
    })();
  </script>
</body>
</html>
