<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Editar producto — J-PLACE</title>
  <link rel="icon" href="images/J-PLACE.png"type="image/png"> 
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header class="header">
    <nav class="navbar">
      <a href="index.html" class="logo"><span class="logo-text">J-PLACE</span></a>
      <div id="user-area" style="display:flex;align-items:center;gap:0.6rem"></div>
    </nav>
  </header>

  <main class="edit-page" style="padding-top:84px;">
    <div class="container">
      <section class="edit-header">
        <h1>Editar producto</h1>
        <p class="muted">Los cambios quedarán pendientes de revisión por el equipo de administración.</p>
      </section>

      <section class="edit-grid">
        <form id="edit-page-form" class="edit-form" enctype="multipart/form-data" novalidate>
          <input type="hidden" id="product-id" name="productId" />

          <div class="form-row">
            <label for="field-nombre">Nombre</label>
            <input id="field-nombre" name="nombre" required placeholder="Ej: Monitor 27'' 4K" />
          </div>

          <div class="form-row two-col">
            <div>
              <label for="field-precio">Precio</label>
              <input id="field-precio" name="precio" type="number" step="0.01" required placeholder="0.00" />
            </div>
            <div>
              <label for="field-currency">Moneda</label>
              <select id="field-currency" name="currency" aria-label="Moneda">
                <option value="USD" selected>USD</option>
                <option value="EUR">EUR</option>
                <option value="PEN">PEN</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <label for="field-descripcion">Descripción</label>
            <textarea id="field-descripcion" name="descripcion" rows="6" required placeholder="Describe el estado, marca y detalles relevantes"></textarea>
          </div>

          <div class="form-row">
            <label for="field-images">Imágenes</label>
            <input id="field-images" name="images" type="file" accept="image/*" multiple />
            <small class="muted">Selecciona hasta 6 imágenes. Si subes nuevas, reemplazarán las actuales.</small>
          </div>

          <div class="form-actions">
            <button id="submit-edit" class="btn-primary" type="submit">Enviar edición</button>
            <a href="javascript:history.back()" class="btn-secondary">Volver</a>
          </div>

          <p id="edit-feedback" class="muted" role="status" aria-live="polite"></p>
        </form>

        <aside class="preview-panel" aria-label="Vista previa">
          <div class="preview-card">
            <h3>Vista previa</h3>
            <div id="existing-images" class="images-grid" aria-live="polite"></div>
            <div class="preview-details">
              <h4 id="preview-nombre" class="muted">—</h4>
              <div class="preview-price" id="preview-precio">&nbsp;</div>
              <p id="preview-descripcion" class="muted">Sin descripción</p>
            </div>
            <div class="notes">
              <p class="muted small">Después de enviar, la edición será revisada. Recibirás una notificación cuando se apruebe o rechace.</p>
            </div>
          </div>
        </aside>
      </section>
    </div>
  </main>

  <script>
  (function(){
    function apiOrigin(){ if(location.protocol==='file:'||location.hostname==='localhost'||location.hostname==='127.0.0.1') return 'http://localhost:4000'; return location.origin; }
    const params = new URLSearchParams(location.search);
    const productId = params.get('productId');

    const feedback = document.getElementById('edit-feedback');
    const form = document.getElementById('edit-page-form');
    const fNombre = document.getElementById('field-nombre');
    const fPrecio = document.getElementById('field-precio');
    const fDesc = document.getElementById('field-descripcion');
    const fImages = document.getElementById('field-images');
    const existing = document.getElementById('existing-images');
    const previewNombre = document.getElementById('preview-nombre');
    const previewPrecio = document.getElementById('preview-precio');
    const previewDesc = document.getElementById('preview-descripcion');

    function clearPreviewImages(){ existing.innerHTML = ''; }
    function addPreviewImage(src, isRemote){
      const wrap = document.createElement('div'); wrap.className = 'image-thumb';
      const img = document.createElement('img'); img.src = src; img.alt = 'Imagen del producto';
      wrap.appendChild(img);
      if (!isRemote) {
        const rm = document.createElement('button'); rm.type='button'; rm.className='remove-btn'; rm.title='Quitar imagen'; rm.innerHTML='✕';
        rm.addEventListener('click', ()=>{ wrap.remove(); });
        wrap.appendChild(rm);
      }
      existing.appendChild(wrap);
    }

    function updatePreviewFields(){
      previewNombre.textContent = fNombre.value.trim() || '—';
      previewPrecio.textContent = fPrecio.value ? (fPrecio.value+' '+(document.getElementById('field-currency')?.value||'')) : '';
      previewDesc.textContent = fDesc.value.trim() || 'Sin descripción';
    }

    if (!productId) {
      feedback.style.color='crimson'; feedback.textContent='Producto no especificado.';
    } else {
      document.getElementById('product-id').value = productId;
      fetch(apiOrigin()+'/api/productos/'+encodeURIComponent(productId)).then(r=>r.json()).then(p=>{
        if (p && p._id) {
          fNombre.value = p.nombre || '';
          fPrecio.value = p.precio != null ? p.precio : '';
          fDesc.value = p.descripcion || '';
          updatePreviewFields();
          // mostrar imágenes actuales (remoto)
          clearPreviewImages();
          if (Array.isArray(p.images) && p.images.length) {
            p.images.forEach(src=>{
              const url = src.startsWith('http') ? src : (apiOrigin()+src);
              addPreviewImage(url, true);
            });
          } else {
            // placeholder
            const ph = document.createElement('div'); ph.className='image-thumb'; ph.textContent='Sin imágenes'; ph.style.display='flex'; ph.style.alignItems='center'; ph.style.justifyContent='center'; ph.style.color='#777'; existing.appendChild(ph);
          }
        } else {
          feedback.style.color='crimson'; feedback.textContent='No se encontró el producto.';
        }
      }).catch(err=>{ console.error(err); feedback.style.color='crimson'; feedback.textContent='Error cargando producto.'; });
    }

    // Actualizar preview en vivo
    [fNombre, fPrecio, fDesc].forEach(el=> el.addEventListener('input', updatePreviewFields));

    // Mostrar previews locales cuando el usuario selecciona archivos nuevos
    fImages.addEventListener('change', ()=>{
      clearPreviewImages();
      const files = Array.from(fImages.files || []);
      if (files.length===0) {
        // volver a cargar imagenes remotas si no hay selección
        fetch(apiOrigin()+'/api/productos/'+encodeURIComponent(productId)).then(r=>r.json()).then(p=>{
          if (Array.isArray(p.images)) p.images.forEach(src=> addPreviewImage(src.startsWith('http')?src:(apiOrigin()+src), true));
        }).catch(()=>{});
        return;
      }
      files.slice(0,6).forEach(file=>{
        const reader = new FileReader();
        reader.onload = (ev)=> addPreviewImage(ev.target.result, false);
        reader.readAsDataURL(file);
      });
    });

    form.addEventListener('submit', async (ev)=>{
      ev.preventDefault(); feedback.textContent='';
      const fd = new FormData();
      const nombre = fNombre.value.trim();
      const precio = fPrecio.value;
      const desc = fDesc.value.trim();
      const currency = document.getElementById('field-currency')?.value;
      if (nombre) fd.append('nombre', nombre);
      if (precio) fd.append('precio', precio);
      if (currency) fd.append('currency', currency);
      if (desc) fd.append('descripcion', desc);
      for (let i=0;i<fImages.files.length;i++) fd.append('images', fImages.files[i]);

      const token = localStorage.getItem('jplace_token');
      try{
        const res = await fetch(apiOrigin()+'/api/productos/'+encodeURIComponent(productId)+'/edits', { method: 'POST', body: fd, headers: token ? { 'Authorization': 'Bearer '+token } : {} });
        const j = await res.json();
        if (!res.ok) { feedback.style.color='crimson'; feedback.textContent = j && j.msg ? j.msg : (j && j.error ? j.error : 'Error enviando edición'); return; }
        feedback.style.color='green'; feedback.textContent = j && j.msg ? j.msg : 'Edición enviada y pendiente de aprobación.';
        setTimeout(()=>{ window.location.href = 'index.html'; }, 1400);
      }catch(e){ console.error(e); feedback.style.color='crimson'; feedback.textContent = 'Error enviando la edición.'; }
    });

  })();
  </script>
</body>
</html>