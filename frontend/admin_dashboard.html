<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Panel de AdministraciÃ³n - J-PLACE</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="header">
    <nav class="navbar">
      <a class="logo" href="index.html"><span class="logo-text">J-PLACE</span></a>
      <div id="user-area"></div>
    </nav>
  </header>

  <div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
      <div class="sidebar-header">
        <h2>ğŸ‘‘ Admin Panel</h2>
      </div>
      <nav class="sidebar-nav">
        <a href="admin_dashboard.html" class="nav-item active">
          <span class="nav-icon">ğŸ“Š</span>
          <span class="nav-label">Dashboard</span>
        </a>
        <a href="admin_users.html" class="nav-item">
          <span class="nav-icon">ğŸ‘¥</span>
          <span class="nav-label">Usuarios</span>
        </a>
        <a href="admin_products.html" class="nav-item">
          <span class="nav-icon">ğŸ“¦</span>
          <span class="nav-label">Productos Reportados</span>
        </a>
        <a href="admin_sellers.html" class="nav-item">
          <span class="nav-icon">ğŸª</span>
          <span class="nav-label">Vendedores de Alto Volumen</span>
        </a>
        <a href="admin_categories.html" class="nav-item">
          <span class="nav-icon">ğŸ·ï¸</span>
          <span class="nav-label">CategorÃ­as y Etiquetas</span>
        </a>
        <a href="admin_commissions.html" class="nav-item">
          <span class="nav-icon">ğŸ’°</span>
          <span class="nav-label">Comisiones y Pagos</span>
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="admin-main">
      <div class="admin-page-header">
        <div>
          <h1>Dashboard de MÃ©tricas</h1>
          <p class="page-subtitle">Resumen general del marketplace</p>
        </div>
        <div class="header-actions">
          <select id="timeRange" class="filter-select">
            <option value="7">Ãšltimos 7 dÃ­as</option>
            <option value="30" selected>Ãšltimos 30 dÃ­as</option>
            <option value="90">Ãšltimos 90 dÃ­as</option>
          </select>
          <button class="btn-primary" onclick="location.reload()">
            ğŸ”„ Actualizar
          </button>
        </div>
      </div>

      <!-- Metrics Grid -->
      <section class="metrics-grid">
        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">ğŸ‘¥</span>
            <span class="metric-trend positive">+12%</span>
          </div>
          <div class="metric-value" id="totalUsers">â€”</div>
          <div class="metric-label">Total Usuarios</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">ğŸ“¦</span>
            <span class="metric-trend positive">+8%</span>
          </div>
          <div class="metric-value" id="totalProducts">â€”</div>
          <div class="metric-label">Productos Activos</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">â³</span>
            <span class="metric-trend warning">!</span>
          </div>
          <div class="metric-value" id="pendingProducts">â€”</div>
          <div class="metric-label">Pendientes AprobaciÃ³n</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">ğŸ’°</span>
            <span class="metric-trend positive">+24%</span>
          </div>
          <div class="metric-value" id="totalRevenue">$â€”</div>
          <div class="metric-label">Ingresos del Mes</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">ğŸ›’</span>
            <span class="metric-trend positive">+15%</span>
          </div>
          <div class="metric-value" id="totalOrders">â€”</div>
          <div class="metric-label">Ventas Totales</div>
        </div>

        <div class="metric-card">
          <div class="metric-header">
            <span class="metric-icon">âš ï¸</span>
            <span class="metric-trend negative">3</span>
          </div>
          <div class="metric-value" id="reportedProducts">â€”</div>
          <div class="metric-label">Productos Reportados</div>
        </div>
      </section>

      <!-- Charts Section -->
      <section class="charts-section">
        <div class="chart-card">
          <div class="chart-header">
            <h3>Productos por CategorÃ­a</h3>
            <button class="btn-ghost">Ver detalles</button>
          </div>
          <div id="categoryChart" class="chart-content">
            <div class="category-bar-chart" id="categoryBarChart"></div>
          </div>
        </div>

        <div class="chart-card">
          <div class="chart-header">
            <h3>Nuevos Usuarios (30 dÃ­as)</h3>
            <button class="btn-ghost">Ver todos</button>
          </div>
          <div id="usersChart" class="chart-content">
            <canvas id="usersLineChart" width="400" height="200"></canvas>
          </div>
        </div>
      </section>

      <!-- Recent Activity -->
      <section class="activity-section">
        <div class="section-header">
          <h2>Actividad Reciente</h2>
          <a href="#" class="link-primary">Ver todo</a>
        </div>
        <div class="activity-list" id="activityList">
          <div class="activity-item">
            <div class="activity-icon">ğŸ“¦</div>
            <div class="activity-content">
              <div class="activity-title">Nuevo producto publicado</div>
              <div class="activity-meta">Usuario123 â€¢ TecnologÃ­a â€¢ Hace 5 min</div>
            </div>
            <button class="btn-ghost-sm">Ver</button>
          </div>
          <div class="activity-item">
            <div class="activity-icon">ğŸ‘¤</div>
            <div class="activity-content">
              <div class="activity-title">Nuevo registro de usuario</div>
              <div class="activity-meta">maria.gomez@email.com â€¢ Hace 12 min</div>
            </div>
            <button class="btn-ghost-sm">Ver</button>
          </div>
          <div class="activity-item">
            <div class="activity-icon">âš ï¸</div>
            <div class="activity-content">
              <div class="activity-title">Producto reportado</div>
              <div class="activity-meta">Monitor Samsung 24" â€¢ Hace 1 hora</div>
            </div>
            <button class="btn-ghost-sm">Revisar</button>
          </div>
        </div>
      </section>

      <!-- Top Sellers -->
      <section class="top-sellers-section">
        <div class="section-header">
          <h2>Mejores Vendedores del Mes</h2>
          <a href="admin_sellers.html" class="link-primary">Ver todos</a>
        </div>
        <div class="sellers-grid">
          <div class="seller-card">
            <div class="seller-rank">#1</div>
            <div class="seller-info">
              <div class="seller-name">TechStore MX</div>
              <div class="seller-stats">
                <span>234 ventas</span> â€¢ <span>$45,890</span>
              </div>
            </div>
            <div class="seller-badge">â­ Top</div>
          </div>
          <div class="seller-card">
            <div class="seller-rank">#2</div>
            <div class="seller-info">
              <div class="seller-name">ModaYEstilo</div>
              <div class="seller-stats">
                <span>198 ventas</span> â€¢ <span>$38,450</span>
              </div>
            </div>
            <div class="seller-badge">ğŸ”¥ Popular</div>
          </div>
          <div class="seller-card">
            <div class="seller-rank">#3</div>
            <div class="seller-info">
              <div class="seller-name">Deportes Pro</div>
              <div class="seller-stats">
                <span>156 ventas</span> â€¢ <span>$29,120</span>
              </div>
            </div>
            <div class="seller-badge">ğŸ“ˆ Subiendo</div>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script src="main.js"></script>
  <script>
    // Auth check
    const token = localStorage.getItem('jplace_token');
    const rawUser = localStorage.getItem('jplace_user');
    const currentUser = rawUser ? JSON.parse(rawUser) : null;
    
    if (!token || !currentUser || currentUser.role !== 'admin') {
      alert('Acceso denegado. Debes ser administrador.');
      location.href = 'index.html';
    }

    // API Origin
    const apiOrigin = (location.protocol==='file:' || location.hostname==='localhost' || location.hostname==='127.0.0.1') 
      ? 'http://localhost:4000' 
      : location.origin;

    // Load Dashboard Data
    async function loadDashboardData() {
      try {
        // Load users count
        const usersRes = await fetch(`${apiOrigin}/api/admin/users`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        const users = await usersRes.json();
        document.getElementById('totalUsers').textContent = users.length || 0;

        // Load products
        const productsRes = await fetch(`${apiOrigin}/api/productos`);
        const products = await productsRes.json();
        document.getElementById('totalProducts').textContent = products.length || 0;

        // Load pending products
        const pendingRes = await fetch(`${apiOrigin}/api/admin/productos/pending`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });
        if (pendingRes.ok) {
          const pending = await pendingRes.json();
          document.getElementById('pendingProducts').textContent = pending.length || 0;
        }

        // Simulated data for other metrics
        document.getElementById('totalRevenue').textContent = '$48,250';
        document.getElementById('totalOrders').textContent = '1,234';
        document.getElementById('reportedProducts').textContent = '3';

        // Generate category chart
        generateCategoryChart(products);

      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }

    function generateCategoryChart(products) {
      const categories = {};
      products.forEach(p => {
        const cat = p.category || 'Sin categorÃ­a';
        categories[cat] = (categories[cat] || 0) + 1;
      });

      const chartEl = document.getElementById('categoryBarChart');
      chartEl.innerHTML = '';
      
      const sorted = Object.entries(categories).sort((a, b) => b[1] - a[1]).slice(0, 8);
      const max = sorted[0]?.[1] || 1;

      sorted.forEach(([cat, count]) => {
        const bar = document.createElement('div');
        bar.className = 'category-bar-item';
        bar.innerHTML = `
          <div class="bar-label">${cat}</div>
          <div class="bar-wrapper">
            <div class="bar-fill" style="width: ${(count / max) * 100}%"></div>
          </div>
          <div class="bar-value">${count}</div>
        `;
        chartEl.appendChild(bar);
      });
    }

    // Initialize
    loadDashboardData();
  </script>
</body>
</html>
